job('{{ job_name }}') {
  description('Destroy Cloud Foundry environment')
  {% if vagrant is defined %}
    disabled(shouldDisable = true)
  {% endif %}
  parameters {
    stringParam("DEPLOY_ENV", "{{ target_environment_name }}",
            "Select which environment you wish to run against")
  }
  scm {
    git {
      remote {
    url('https://github.com/alphagov/cf-terraform.git')
      }
      branch('master')
      createTag(false)
    }
  }
  wrappers {
    colorizeOutput()
  }
  publishers {
    mailer("the-multi-cloud-paas-team@digital.cabinet-office.gov.uk", false, true)
  }
  steps {
shell('''#!/bin/bash

echo Set-up ssh keys and credentials
mkdir -p gce/ssh aws/ssh
cp ~/.ssh/* gce/ssh
cp ~/.ssh/* aws/ssh
cp ~/.account.json gce/account.json
. ~/.aws_credentials
export TF_VAR_AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
export TF_VAR_AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
export TF_VAR_GCE_INTEROPERABILITY_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
export TF_VAR_GCE_INTEROPERABILITY_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
export TF_VAR_GCE_INTEROPERABILITY_HOST=s3-eu-west-1.amazonaws.com

echo Setting up ssh-agent and cleanup trap
eval $(ssh-agent) && ssh-add ~/.ssh/insecure-deployer
set -e
trap "kill ${SSH_AGENT_PID}" ERR

echo Retrieving Terraform state
ln -sf ~/${DEPLOY_ENV}_{{ platform }}.tfstate {{ platform }}/${DEPLOY_ENV}.tfstate
ln -sf ~/${DEPLOY_ENV}_{{ platform }}.tfstate.backup {{ platform }}/${DEPLOY_ENV}.tfstate.backup

make destroy-{{ platform }} DEPLOY_ENV=${DEPLOY_ENV} ROOT_PASS_DIR=jenkins SKIP_CONFIRM=1
''')
  }

}
